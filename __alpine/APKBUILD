# Maintainer: Jean-Francois Gratton <jean-francois@famillegratton.net>
# Packager: APK Builder <builder@famillegratton.net>
pkgname=stubber
pkgver=1.90.01
pkgrel=0
pkgdir=/data/packages
pkgdesc="Create GOLANG software skeleton"
url="https://github.com/jeanfrancoisgratton/stubber"
arch=x86_64
license=GPL2
#depends="gcompat"
makedepends="go sudo"
install="$pkgname.pre-install $pkgname.post-install"
#source="$pkgname-$pkgver-$pkgrel.tar.bz2::http://localhost/$pkgname-$pkgver-$pkgrel.tar.bz2"
builddir="$startdir/src/BUILD"
binaryname="stubber"

prepare() {
	mkdir -p "$builddir"
	# copy your repo's src directory next to __alpine
	cp -R "$startdir"/../src/* "$builddir"/
}

build() {
	cd "$builddir"

	# Ensure no global PIE flags leak in
	unset GOFLAGS
	export GOENV=off
	export CGO_ENABLED=0
	export GOOS=linux GOARCH=amd64
	export GO111MODULE=on

	go env | egrep 'GOFLAGS|CGO_ENABLED|GOOS|GOARCH' || true

	# Static, non-PIE, internal linker
	go build -trimpath -ldflags="-s -w -buildid= -linkmode=internal" -o "$binaryname" .
}

package() {
	install -d "$pkgdir"/opt/bin
	install -m755 "$builddir/$binaryname" "$pkgdir/opt/bin/$binaryname"
}

